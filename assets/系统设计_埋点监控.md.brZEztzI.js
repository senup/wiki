import{_ as s,o as n,c as a,R as p}from"./chunks/framework.7FlijoJG.js";const F=JSON.parse('{"title":"埋点监控","description":"","frontmatter":{"title":"埋点监控","date":"2024-01-19T13:37:01.000Z","Tags":["tech"],"Draft":true,"HideInList":false,"Feature":null,"IsTop":false},"headers":[],"relativePath":"系统设计/埋点监控.md","filePath":"系统设计/埋点监控.md","lastUpdated":1711296414000}'),l={name:"系统设计/埋点监控.md"},o=p(`<p>这个注解实现的主要步骤如下:</p><ol><li><p>使用@Aspect、@Component 注解声明这个类是一个切面</p></li><li><p>使用@Pointcut 定义一个切入点,针对带有@ControllerStatusMetrics 注解的方法</p></li><li><p>使用@AfterThrowing 在方法抛出异常时执行逻辑</p></li><li><p>使用@AfterReturning 在方法正常返回时执行逻辑</p></li><li><p>在@AfterThrowing 逻辑中,获取异常信息,获取指标类型,记录异常码的指标</p></li><li><p>在@AfterReturning 逻辑中,获取返回结果,判断是 Response 类型,获取返回码,获取指标类型,记录返回码的指标</p></li><li><p>获取指标类型的方式是通过 joinPoint 获取方法签名和方法,从方法的@ControllerStatusMetrics 注解中获取 metricsItem</p></li><li><p>记录指标的方法是调用 MetricsTools 来增加某种类型指标的计数</p></li><li><p>这样就可以在方法执行后记录下返回码或异常码的指标,用于监控统计。</p></li></ol><p>总结一下就是:</p><ol><li><p>声明一个切面</p></li><li><p>定义切点,指定要切入的方法</p></li><li><p>在返回和抛出异常时分别执行记录指标逻辑</p></li><li><p>获取方法签名,通过注解获取指标类型</p></li><li><p>调用 MetricsTools 记录指标</p></li><li><p>完成指标统计</p></li></ol><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> cn.dotfashion.soa.gmp.gmpsso.common.metrics;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> cn.dotfashion.soa.framework.exception.BusinessException;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> cn.dotfashion.soa.framework.util.MetricsTools;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> cn.dotfashion.soa.gmp.gmpsso.common.enums.BusinessEnum;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.apache.commons.lang3.StringUtils;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.aspectj.lang.JoinPoint;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.aspectj.lang.annotation.AfterReturning;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.aspectj.lang.annotation.AfterThrowing;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.aspectj.lang.annotation.Aspect;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.aspectj.lang.annotation.Pointcut;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.aspectj.lang.reflect.MethodSignature;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> cn.dotfashion.soa.api.vo.Response;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> java.lang.reflect.Method;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Component</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Aspect</span></span>
<span class="line"><span style="color:#E1E4E8;">@</span><span style="color:#F97583;">Slf4j</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ControllerStatusMetricsAop</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> String RESPONSE_CODE_TAG_NAME </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;response_code&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">     * 定义切入点，只针对有这个ControllerStatusMetrics注解的方法</span></span>
<span class="line"><span style="color:#6A737D;">     */</span></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">Pointcut</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;@annotation(cn.dotfashion.soa.gmp.gmpsso.common.metrics.ControllerStatusMetrics)&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">controllerStatusMetricsPointcut</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">AfterThrowing</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">throwing</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ex&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">pointcut</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;controllerStatusMetricsPointcut()&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">handleThrow</span><span style="color:#E1E4E8;">(JoinPoint </span><span style="color:#FFAB70;">joinPoint</span><span style="color:#E1E4E8;">,BusinessException </span><span style="color:#FFAB70;">ex</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> ex </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> StringUtils.</span><span style="color:#B392F0;">isBlank</span><span style="color:#E1E4E8;">(ex.</span><span style="color:#B392F0;">getCode</span><span style="color:#E1E4E8;">())){</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">//获取指标类型</span></span>
<span class="line"><span style="color:#E1E4E8;">        BusinessEnum.MetricsItemEnum metricsItem </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getMetricsItem</span><span style="color:#E1E4E8;">(joinPoint);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">calculateResponseCode</span><span style="color:#E1E4E8;">(metricsItem,ex.</span><span style="color:#B392F0;">getCode</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    @</span><span style="color:#F97583;">AfterReturning</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">pointcut</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;controllerStatusMetricsPointcut()&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">returning</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;returnObj&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">handleReturn</span><span style="color:#E1E4E8;">(JoinPoint </span><span style="color:#FFAB70;">joinPoint</span><span style="color:#E1E4E8;">, Object </span><span style="color:#FFAB70;">returnObj</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">//判断类型</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">(returnObj </span><span style="color:#F97583;">instanceof</span><span style="color:#E1E4E8;"> Response)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        Response response </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (Response) returnObj;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">//判断返回码</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(StringUtils.</span><span style="color:#B392F0;">isBlank</span><span style="color:#E1E4E8;">(response.</span><span style="color:#B392F0;">getCode</span><span style="color:#E1E4E8;">())){</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">//获取指标类型</span></span>
<span class="line"><span style="color:#E1E4E8;">        BusinessEnum.MetricsItemEnum metricsItem </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getMetricsItem</span><span style="color:#E1E4E8;">(joinPoint);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">calculateResponseCode</span><span style="color:#E1E4E8;">(metricsItem,response.</span><span style="color:#B392F0;">getCode</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">calculateResponseCode</span><span style="color:#E1E4E8;">(BusinessEnum.MetricsItemEnum </span><span style="color:#FFAB70;">metricsItem</span><span style="color:#E1E4E8;">, String </span><span style="color:#FFAB70;">responseCode</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> metricsItem</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">StringUtils.</span><span style="color:#B392F0;">isBlank</span><span style="color:#E1E4E8;">(responseCode)){</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            MetricsTools.</span><span style="color:#B392F0;">counterIncr</span><span style="color:#E1E4E8;">(metricsItem,RESPONSE_CODE_TAG_NAME, responseCode);</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Exception </span><span style="color:#FFAB70;">exception</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            log.</span><span style="color:#B392F0;">warn</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;监控数据出错，name:{}, tags:{}, exception:{}&quot;</span><span style="color:#E1E4E8;">, metricsItem.</span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">(), responseCode,exception.</span><span style="color:#B392F0;">getMessage</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> BusinessEnum.MetricsItemEnum </span><span style="color:#B392F0;">getMetricsItem</span><span style="color:#E1E4E8;">(JoinPoint </span><span style="color:#FFAB70;">joinPoint</span><span style="color:#E1E4E8;">){</span></span>
<span class="line"><span style="color:#E1E4E8;">        MethodSignature signature </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (MethodSignature) joinPoint.</span><span style="color:#B392F0;">getSignature</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        Method method </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> signature.</span><span style="color:#B392F0;">getMethod</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">        ControllerStatusMetrics controllerStatusMetrics </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> method.</span><span style="color:#B392F0;">getAnnotation</span><span style="color:#E1E4E8;">(ControllerStatusMetrics.class);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> controllerStatusMetrics.</span><span style="color:#B392F0;">metricsItem</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> cn.dotfashion.soa.gmp.gmpsso.common.metrics;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> cn.dotfashion.soa.framework.exception.BusinessException;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> cn.dotfashion.soa.framework.util.MetricsTools;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> cn.dotfashion.soa.gmp.gmpsso.common.enums.BusinessEnum;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.apache.commons.lang3.StringUtils;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.aspectj.lang.JoinPoint;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.aspectj.lang.annotation.AfterReturning;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.aspectj.lang.annotation.AfterThrowing;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.aspectj.lang.annotation.Aspect;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.aspectj.lang.annotation.Pointcut;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.aspectj.lang.reflect.MethodSignature;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> org.springframework.stereotype.Component;</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> cn.dotfashion.soa.api.vo.Response;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> java.lang.reflect.Method;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Component</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Aspect</span></span>
<span class="line"><span style="color:#24292E;">@</span><span style="color:#D73A49;">Slf4j</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ControllerStatusMetricsAop</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> String RESPONSE_CODE_TAG_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;response_code&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">    /**</span></span>
<span class="line"><span style="color:#6A737D;">     * 定义切入点，只针对有这个ControllerStatusMetrics注解的方法</span></span>
<span class="line"><span style="color:#6A737D;">     */</span></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">Pointcut</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;@annotation(cn.dotfashion.soa.gmp.gmpsso.common.metrics.ControllerStatusMetrics)&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">controllerStatusMetricsPointcut</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">AfterThrowing</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">throwing</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ex&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">pointcut</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;controllerStatusMetricsPointcut()&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">handleThrow</span><span style="color:#24292E;">(JoinPoint </span><span style="color:#E36209;">joinPoint</span><span style="color:#24292E;">,BusinessException </span><span style="color:#E36209;">ex</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> ex </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> StringUtils.</span><span style="color:#6F42C1;">isBlank</span><span style="color:#24292E;">(ex.</span><span style="color:#6F42C1;">getCode</span><span style="color:#24292E;">())){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//获取指标类型</span></span>
<span class="line"><span style="color:#24292E;">        BusinessEnum.MetricsItemEnum metricsItem </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getMetricsItem</span><span style="color:#24292E;">(joinPoint);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">calculateResponseCode</span><span style="color:#24292E;">(metricsItem,ex.</span><span style="color:#6F42C1;">getCode</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    @</span><span style="color:#D73A49;">AfterReturning</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">pointcut</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;controllerStatusMetricsPointcut()&quot;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">returning</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;returnObj&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">handleReturn</span><span style="color:#24292E;">(JoinPoint </span><span style="color:#E36209;">joinPoint</span><span style="color:#24292E;">, Object </span><span style="color:#E36209;">returnObj</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//判断类型</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">(returnObj </span><span style="color:#D73A49;">instanceof</span><span style="color:#24292E;"> Response)) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        Response response </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (Response) returnObj;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//判断返回码</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(StringUtils.</span><span style="color:#6F42C1;">isBlank</span><span style="color:#24292E;">(response.</span><span style="color:#6F42C1;">getCode</span><span style="color:#24292E;">())){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">//获取指标类型</span></span>
<span class="line"><span style="color:#24292E;">        BusinessEnum.MetricsItemEnum metricsItem </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getMetricsItem</span><span style="color:#24292E;">(joinPoint);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">calculateResponseCode</span><span style="color:#24292E;">(metricsItem,response.</span><span style="color:#6F42C1;">getCode</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">calculateResponseCode</span><span style="color:#24292E;">(BusinessEnum.MetricsItemEnum </span><span style="color:#E36209;">metricsItem</span><span style="color:#24292E;">, String </span><span style="color:#E36209;">responseCode</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> metricsItem</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">StringUtils.</span><span style="color:#6F42C1;">isBlank</span><span style="color:#24292E;">(responseCode)){</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            MetricsTools.</span><span style="color:#6F42C1;">counterIncr</span><span style="color:#24292E;">(metricsItem,RESPONSE_CODE_TAG_NAME, responseCode);</span></span>
<span class="line"><span style="color:#24292E;">        }</span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">exception</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            log.</span><span style="color:#6F42C1;">warn</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;监控数据出错，name:{}, tags:{}, exception:{}&quot;</span><span style="color:#24292E;">, metricsItem.</span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">(), responseCode,exception.</span><span style="color:#6F42C1;">getMessage</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">private</span><span style="color:#24292E;"> BusinessEnum.MetricsItemEnum </span><span style="color:#6F42C1;">getMetricsItem</span><span style="color:#24292E;">(JoinPoint </span><span style="color:#E36209;">joinPoint</span><span style="color:#24292E;">){</span></span>
<span class="line"><span style="color:#24292E;">        MethodSignature signature </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (MethodSignature) joinPoint.</span><span style="color:#6F42C1;">getSignature</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        Method method </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> signature.</span><span style="color:#6F42C1;">getMethod</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">        ControllerStatusMetrics controllerStatusMetrics </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> method.</span><span style="color:#6F42C1;">getAnnotation</span><span style="color:#24292E;">(ControllerStatusMetrics.class);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> controllerStatusMetrics.</span><span style="color:#6F42C1;">metricsItem</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div>`,5),e=[o];function t(c,r,E,y,i,u){return n(),a("div",null,e)}const g=s(l,[["render",t]]);export{F as __pageData,g as default};
