import{_ as s,o as n,c as a,R as l}from"./chunks/framework.7FlijoJG.js";const d=JSON.parse('{"title":"githooks钩子函数","description":"","frontmatter":{"title":"githooks钩子函数","date":"2023-12-23T19:44:54.000Z","Tags":["tech"],"Draft":true,"HideInList":false,"Feature":null,"IsTop":false},"headers":[],"relativePath":"规范/githooks钩子函数.md","filePath":"规范/githooks钩子函数.md","lastUpdated":1711296414000}'),p={name:"规范/githooks钩子函数.md"},o=l(`<p>作用：可以将开发、测试环境的分支名添加到黑名单列表中，这样做合并的时候不会出现误合并黑名单分支。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 设置黑名单分支列表，按需添加其他分支名</span></span>
<span class="line"><span style="color:#E1E4E8;">BLACKLIST</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;branch1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;branch2&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 初始化禁止合并的分支哈希值列表</span></span>
<span class="line"><span style="color:#E1E4E8;">forbid_list</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">() </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如果存在 .git/MERGE_HEAD ，表明当前正处在合并状态</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> .git/MERGE_HEAD ]]; </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 遍历黑名单分支列表</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> bl </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;\${</span><span style="color:#E1E4E8;">BLACKLIST</span><span style="color:#9ECBFF;">[@]}&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 检查黑名单分支是否存在</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> .git/refs/heads/\${bl} ]]; </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 如果存在，获取该分支最新commit的哈希值，存入禁止合并列表</span></span>
<span class="line"><span style="color:#E1E4E8;">            forbid_list</span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">cat</span><span style="color:#9ECBFF;"> .git/refs/heads/\${</span><span style="color:#E1E4E8;">bl</span><span style="color:#9ECBFF;">}\`</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">done</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 获取当前合并操作引入的commit的哈希值</span></span>
<span class="line"><span style="color:#E1E4E8;">    merge_head</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">cat</span><span style="color:#9ECBFF;"> .git/MERGE_HEAD\`</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 遍历禁止合并的分支哈希值列表</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> br </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;\${</span><span style="color:#E1E4E8;">forbid_list</span><span style="color:#9ECBFF;">[@]}&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 检查当前合并操作是否涉及到禁止合并的分支</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ \${merge_head} </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> \${br} ]]; </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 若涉及，则输出警告信息，并要求执行 git merge --abort 命令取消合并</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;\\033[41;37m Attempt to merge a branch from the blacklist \\033[0m\\n\\r&quot;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;\\033[41;37m Please use the command &#39;git merge --abort&#39; to cancel the merge \\033[0m&quot;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 终止脚本运行，中止提交操作</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">exit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">fi</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">done</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">fi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 设置黑名单分支列表，按需添加其他分支名</span></span>
<span class="line"><span style="color:#24292E;">BLACKLIST</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;branch1&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;branch2&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 初始化禁止合并的分支哈希值列表</span></span>
<span class="line"><span style="color:#24292E;">forbid_list</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">() </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如果存在 .git/MERGE_HEAD ，表明当前正处在合并状态</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> .git/MERGE_HEAD ]]; </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 遍历黑名单分支列表</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> bl </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;\${</span><span style="color:#24292E;">BLACKLIST</span><span style="color:#032F62;">[@]}&quot;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 检查黑名单分支是否存在</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> .git/refs/heads/\${bl} ]]; </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 如果存在，获取该分支最新commit的哈希值，存入禁止合并列表</span></span>
<span class="line"><span style="color:#24292E;">            forbid_list</span><span style="color:#D73A49;">+=</span><span style="color:#24292E;">(</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">cat</span><span style="color:#032F62;"> .git/refs/heads/\${</span><span style="color:#24292E;">bl</span><span style="color:#032F62;">}\`</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">done</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 获取当前合并操作引入的commit的哈希值</span></span>
<span class="line"><span style="color:#24292E;">    merge_head</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">cat</span><span style="color:#032F62;"> .git/MERGE_HEAD\`</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 遍历禁止合并的分支哈希值列表</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> br </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;\${</span><span style="color:#24292E;">forbid_list</span><span style="color:#032F62;">[@]}&quot;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 检查当前合并操作是否涉及到禁止合并的分支</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ \${merge_head} </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> \${br} ]]; </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 若涉及，则输出警告信息，并要求执行 git merge --abort 命令取消合并</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;\\033[41;37m Attempt to merge a branch from the blacklist \\033[0m\\n\\r&quot;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;\\033[41;37m Please use the command &#39;git merge --abort&#39; to cancel the merge \\033[0m&quot;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 终止脚本运行，中止提交操作</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">exit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">fi</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">done</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span></code></pre></div><p>保存此脚本为<code>.git/hooks/prepare-commit-msg</code>文件，并运行<code>chmod +x .git/hooks/prepare-commit-msg</code>使其具备执行权限。记得每次合并操作时使用<code>--no-ff</code>选项。你可以通过<code>git config --global alias.m &#39;merge --no-ff&#39;</code>命令设置别名，方便后续的非快进合并操作。</p>`,3),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const h=s(p,[["render",t]]);export{d as __pageData,h as default};
